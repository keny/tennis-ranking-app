# テニスランキングシステム - 引き継ぎドキュメント

## プロジェクト概要

JTAベテランランキングの自動取得・管理・分析システムです。2024年12月から開発を開始し、現在はデータ取得機能とランキング表示機能が完成しています。

## 現在の実装状況（2025年6月14日）

### ✅ 完了済み機能

1. **データベース設計**
   - Prisma ORMを使用したスキーマ定義
   - Player（選手）とRanking（ランキング）テーブル
   - 年齢カテゴリ遷移対応

2. **スクレイピング機能**
   - 最新ランキング自動取得
   - アーカイブ取得（2004年〜）
   - バッチ処理対応
   - エラーハンドリング完備

3. **管理画面** (`/admin/scraping`)
   - 統計表示
   - 期間別処理状況
   - バッチスクレイピング
   - 自動更新（10秒ごと、ページアクティブ時のみ）

4. **ランキング一覧表示** (`/rankings`)
   - カテゴリ別表示
   - フィルター機能（年月、性別、種目、年齢）
   - ページネーション
   - 表示件数調整（100件〜全件）
   - レスポンシブデザイン

5. **選手個別ページ** (`/players/[id]`)
   - 選手プロフィール表示
   - ランキング推移グラフ（Chart.js）
   - カテゴリ別ランキング履歴
   - 順位/ポイント推移の切り替え
   - 複数カテゴリの同時表示

6. **カテゴリ分析** (`/analysis/category`)
   - Top128選手のランキング推移グラフ
   - ランク帯別一括選択（Top 1-32, 33-64, 65-128）
   - 最大128名の同時表示
   - マウスオーバーによる選手の強調表示
   - 新規ランクイン・ランク外の可視化

7. **ホームページ** (`/`)
   - システム統計表示
   - 機能への導線

### 🔄 開発中・未実装

- 検索機能（選手名、都道府県）
- CSVエクスポート
- 自動更新（Cron）
- 複数選手の詳細比較機能

## 技術的な注意点

### データベース

**Prismaスキーマの特徴**：
- `rankingDate`でランキング日付を管理（year/monthフィールドは存在しない）
- `gender`は`male`/`female`（M/Fではない）
- `type`は`singles`/`doubles`（S/Dではない）
- `ageGroup`は数値型（35, 40, 45...）

### JTAサイトの仕様

1. **日付ルール**
   - 月末日付（28日以降）は翌月のランキング扱い
   - 例：4月30日付 → 5月のランキング

2. **カテゴリコード**
   - 形式：`{gender}{type}{age}`
   - 例：`ms45` = 男子シングルス45歳以上

3. **スクレイピング制限**
   - 1秒間隔でリクエスト
   - 100件ごとに5秒休憩

## よく使うコマンド

### 開発環境

```bash
# 開発サーバー起動
npm run dev

# Prisma Studio（DB管理画面）
npx prisma studio

# Prismaクライアント再生成
npx prisma generate

# DBスキーマ適用
npx prisma db push

# Chart.jsインストール（グラフ機能用）
npm install chart.js react-chartjs-2
```

### データ管理

```bash
# 重複選手データ削除
npx tsx scripts/cleanup-player-duplicates.ts 2025 6

# 特定月のデータ削除
npx tsx scripts/delete-month-data.ts 2025 6

# アーカイブ期間更新
npx tsx scripts/update-archive-periods.ts
```

## エラー対処法

### よくあるエラー

1. **PrismaClientValidationError**
   - 原因：フィールド名の間違い
   - 対処：スキーマを確認し、正しいフィールド名を使用

2. **スクレイピングエラー**
   - 原因：JTAサイトの構造変更
   - 対処：`jta-scraper.ts`のセレクタを更新

3. **重複データ**
   - 原因：同じ期間を複数回スクレイピング
   - 対処：cleanup-player-duplicates.tsを実行

## 開発の継続方法

### 次に実装すべき機能（優先度順）

1. **検索機能**
   - 選手名での検索
   - 都道府県フィルター
   - 所属クラブ検索
   - ランキング一覧ページへの統合

2. **データエクスポート機能**
   - ランキング一覧のCSVダウンロード
   - 選手個別データのエクスポート
   - カテゴリ分析結果のエクスポート

3. **高度な分析機能**
   - 複数選手の詳細比較
   - ランキング変動の統計分析
   - カテゴリ移行時のパフォーマンス分析
   - ポイント獲得効率の分析

4. **自動更新機能**
   - Vercel Cronを使用した定期更新
   - 更新履歴の管理
   - 差分データの通知機能

### コード構成のポイント

- **Server Components優先**：パフォーマンスのため
- **Suspense活用**：ローディング状態の管理
- **型安全性**：TypeScriptで厳密に型定義
- **エラーハンドリング**：try-catchで適切に処理

## 環境構築チェックリスト

- [ ] Node.js 18以上インストール
- [ ] PostgreSQL接続設定
- [ ] 環境変数設定（DATABASE_URL）
- [ ] Prismaクライアント生成
- [ ] 初回データ取得（管理画面から）

## 連絡事項

- Vercelにデプロイ済み
- Supabaseでデータベース管理
- GitHubで継続的な開発

質問があれば、GitHubのIssueで管理してください。