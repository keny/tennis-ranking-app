# テニスランキングシステム 開発日誌

## 2025年6月13日（木）- 初期開発

### 開発内容
- プロジェクトの初期セットアップ
- データベース設計（Prisma + PostgreSQL）
- JTAスクレイピング機能の基本実装
- 管理画面の作成

### 実装機能
- Prismaスキーマ定義（Player, Ranking, ScrapingLog）
- JTAサイトからのデータ取得機能
- バッチ処理機能
- 基本的な管理画面UI

---

## 2025年6月14日（金）

### 午前（9:00-12:00）- ランキング一覧ページ実装

#### 実装内容
- `/rankings` ページの作成
- Server Componentsを使用した高速データフェッチ
- フィルター機能の実装
  - 年月選択（ドロップダウン）
  - 性別（男子/女子）
  - 種目（シングルス/ダブルス）
  - 年齢カテゴリ（35歳〜85歳以上）
  - 表示件数（100件〜全件）
- ページネーション機能
- レスポンシブデザイン対応

#### 技術的な工夫
- デフォルト表示件数を100件に設定
- 「全て表示」オプションで全データ表示可能
- 同着（isTied）の表示対応

#### 解決した問題
- Prismaスキーマとの不整合（year/monthフィールド → rankingDate）
- 表示件数の最適化

### 午後前半（13:00-15:00）- 選手個別ページ実装

#### 実装内容
- `/players/[id]` 動的ルーティングページの作成
- 選手プロフィール表示コンポーネント（PlayerInfo）
- ランキング推移グラフ（RankingChart）
  - Chart.jsの導入
  - 順位推移/ポイント推移の切り替え機能
  - 複数カテゴリの同時表示

#### 技術的な工夫
- 動的ルーティングで1万人以上の選手に対応
- カテゴリ別ランキング履歴の表示
- 404ページの実装

#### 解決した問題
- `estimatedBirthYear`エラー（不要な年齢計算を削除）
- コンポーネント名の競合（PlayerProfile → PlayerInfo）
- Chart.jsの初期化エラー

### 午後後半（15:00-16:00）- 管理画面の改善

#### 実装内容
- 自動更新機能の最適化
- ページ非アクティブ時の更新停止
- エラーハンドリングの強化

#### 技術的な工夫
- `visibilitychange` APIの活用
- 自動更新のON/OFF切り替え機能
- useCallbackによるパフォーマンス最適化

### 夕方（16:00-18:30）- カテゴリ分析機能実装

#### 実装内容
- `/analysis/category` ページの作成
- Top128選手のランキング推移を折れ線グラフで可視化
- インタラクティブな選手選択機能
  - 全選択/全解除ボタン
  - ランク帯別選択（Top 1-32, 33-64, 65-128）
  - 個別チェックボックス

#### 技術的な工夫
- 最大128名の同時表示対応
- HSL色空間による128色の自動生成
- マウスオーバーによる選手の強調表示
- パフォーマンス最適化
  - 20名以上で凡例非表示
  - 50名以上でアニメーション無効化
  - ポイントサイズと線の太さの動的調整

#### 実装の進化
1. 最初：表形式での表示
2. 改善1：折れ線グラフの追加（8名制限）
3. 改善2：128名全員表示対応
4. 改善3：ランク帯選択機能
5. 最終：表形式を削除してグラフ特化

---

## 2025年6月15日（土）

### 午前（10:00-12:00）- 管理画面のバグ修正

#### 実装内容
- アーカイブデータ取得機能のカテゴリ指定バグを修正
- カテゴリコード形式の統一

#### 技術的な詳細
- **問題**: 特定カテゴリを指定しても全カテゴリのデータを取得してしまう
- **原因**: カテゴリコードの形式不一致
  - フロントエンド: `ms45`（male/singles/45）
  - JTA仕様: `gs45`（gentlemen/singles/45）
- **修正ファイル**:
  - `app/api/admin/scraping/archive/route.ts`
  - `app/admin/scraping/page.tsx`
- **解決方法**: 
  - 男子=`g`(gentlemen)、女子=`l`(ladies)に統一
  - APIとフロントエンドの両方で修正

#### 学んだこと
- JTAのカテゴリコード体系は独自仕様
- URLパラメータの実装から仕様を推測する必要があった

### 午後前半（13:00-15:00）- カテゴリ分析ページのUI改善

#### 実装内容
1. **期間別・カテゴリ別データ数表示機能**
   - `components/CategoryDataStatus.tsx`を新規作成
   - 最新期間の全44カテゴリのデータ取得状況を可視化
   - 不足カテゴリを赤色で表示

2. **ランキング推移分析の折りたたみ化**
   - `components/RankingAnalysisSection.tsx`を新規作成
   - 分析条件フォームとグラフを折りたたみ可能に
   - 情報の優先度を明確化

#### 技術的な工夫
- Server ComponentとClient Componentの適切な分離
- 折りたたみUIによる画面の整理
- `children`プロパティを使用したコンポーネント間の連携

### 午後後半（15:00-17:00）- Next.js 15対応とバックグラウンド処理

#### Next.js 15への対応
- **問題**: `searchParams`の直接アクセスでエラー
- **解決方法**:
  ```typescript
  // 変更前
  export default async function Page({ searchParams }: { searchParams: SearchParams }) {
  // 変更後  
  export default async function Page({ searchParams }: { searchParams: Promise<SearchParams> }) {
    const params = await searchParams;
  ```
- **影響範囲**: `app/analysis/category/page.tsx`

#### バックグラウンドスクレイピング機能
- **新規作成**: `scripts/run-batch-scraping.ts`
- **機能**:
  - スタンドアロン実行可能なスクリプト
  - リアルタイム進捗表示
  - 推定残り時間の計算
  - 成功/失敗数の集計
- **使用方法**:
  ```bash
  # ターミナル1: Web開発
  npm run dev
  # ターミナル2: データ取得
  npx tsx scripts/run-batch-scraping.ts 2024 1 2024 12
  ```

#### 実装の利点
- Web開発とデータ取得を並行実行可能
- 長時間のスクレイピングでも開発を止めない
- 進捗が可視化されて安心

### 技術的な発見と学び

1. **Next.js 15の破壊的変更**
   - 動的ルートのパラメータがPromiseになった
   - より効率的な並列データフェッチが可能に

2. **UI/UXの改善指針**
   - 大量情報は折りたたみUIで整理
   - 初期表示は概要のみ、詳細はオンデマンド
   - 進捗表示は不安を解消する重要な要素

3. **開発効率の向上**
   - バックグラウンド処理により待ち時間を削減
   - 並行作業により生産性が向上

---

## 今後の開発予定

### 短期目標（1-2週間）
- [x] ~~カテゴリ指定バグの修正~~（完了）
- [x] ~~バックグラウンド実行機能~~（完了）
- [ ] 検索機能の実装
- [ ] CSVエクスポート機能
- [ ] ランキング一覧の高速化

### 中期目標（1ヶ月）
- [ ] 複数選手の詳細比較機能
- [ ] 統計分析ダッシュボード
- [ ] 自動更新機能（Vercel Cron）
- [ ] モバイルアプリ対応

### 長期目標（3ヶ月）
- [ ] AI予測機能
- [ ] 大会結果との連携
- [ ] SNS共有機能
- [ ] GraphQLまたはtRPCの導入

---

## 技術的な学び

### Next.js 15 + App Router
- Server Componentsの活用でパフォーマンス向上
- Suspenseによるローディング状態の管理
- 動的ルーティングの柔軟性
- **NEW**: searchParamsのPromise化への対応

### Chart.js
- 大量データ表示時の最適化が重要
- インタラクティブ機能の実装方法
- カスタマイズの柔軟性

### Prisma + PostgreSQL
- 効率的なクエリの重要性
- インデックスの適切な設定
- リレーションの活用

### 開発効率化
- **NEW**: バックグラウンド処理の重要性
- **NEW**: 進捗可視化によるUX向上

---

## メモ・備考

- JTAランキングの更新は月1回（月末）
- 月末日付（28日以降）は翌月扱い
- 選手は複数カテゴリに同時参加可能
- データ量：選手約15,000名、ランキングデータ約100万件
- **NEW**: カテゴリコードは g=gentlemen, l=ladies
- **NEW**: 全データの初回取得には3-4時間必要

---

最終更新: 2025年6月15日 17:00